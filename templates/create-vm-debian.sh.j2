#!/bin/bash

QSTRING="{{ ansible_role_libvirtd.qstring }}"
BOXNAME="{{ item.value.boxname }}"
HOSTNAME=$(echo $1 | cut -f1 -d.)
DOMAIN=$(echo $1 | cut -f2- -d.)

virsh --connect $QSTRING list --all | grep $BOXNAME 
if [ "$?" == 0 ]; then
  virsh --connect $QSTRING destroy $BOXNAME
  virsh --connect $QSTRING undefine $BOXNAME --remove-all-storage
fi

virt-install \
  --connect qemu:///system \
  --memory {{ item.value.memory }} \
  --vcpus {{ item.value.cpu }} \
  --cpu host \
  --disk size={{ item.value.disksize }},pool={{ ansible_role_libvirtd.zvol }},bus=virtio \
  --net network={{ ansible_role_libvirtd.netname }},model=virtio \
  --os-variant {{ item.value.osvariant }} \
  --os-type linux \
  --name "$1" \
  --noautoconsole \
  --console pty,target_type=serial \
  --location 'http://{{ approx_host_port }}/{{ item.key }}/{{ item.value.installpath }}' \
  --extra-args "console=tty0,ttyS0,115200n8 serial auto language=en country=CH locale=en_GB.UTF-8 keymap=us hostname=$HOSTNAME domain=$DOMAIN preseed/url=http://{{ preseed_host }}/debian/debian.preseed "
