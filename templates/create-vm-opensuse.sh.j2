#!/bin/bash
QSTRING="qemu:///system"
BOXNAME="base-debian-9.sigkill.noexit"
HOSTNAME=$(echo $1 | cut -f1 -d.)
DOMAIN=$(echo $1 | cut -f2- -d.)

virsh --connect $QSTRING list --all | grep $BOXNAME 
if [ "$?" == 0 ]; then
  virsh --connect $QSTRING destroy $BOXNAME
  virsh --connect $QSTRING undefine $BOXNAME --remove-all-storage
fi

virt-install \
  --connect qemu:///system \
  --memory 1024 \
  --vcpus 2 \
  --cpu host \
  --disk size=10,pool={{ ansible_role_libvirtd.zvol }},bus=virtio \
  --net network={{ ansible_role_libvirtd.netname }},model=virtio \
  --os-variant opensuse12 \
  --os-type linux \
  --name "$1" \
  --noautoconsole \
  --console pty,target_type=serial \
  --location http://{{ approx_host_port }}/download.opensuse.org/distribution/leap/42.2/repo/oss/ \
  --extra-args "console=tty0,ttyS0,115200n8 serial install=http://{{ approx_host_port }}/download.opensuse.org/distribution/leap/42.2/repo/oss autoyast=http://{{ preseed_host }}/opensuse/opensuse.preseed textmode"
