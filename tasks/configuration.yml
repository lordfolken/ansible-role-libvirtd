---
 - name: configure libvirtd
   template:
     src: libvirtd.conf.j2
     dest: "{{ ansible_role_libvirtd_conf_path }}"
     owner: root
     group: root
     mode: 0644
   notify: restart_libvirtd

 - name: ensure libvirtd is running
   service:
     name: "{{ ansible_role_libvirtd_service_name }}"
     state: started
     enabled: true

 - name: add users to libvirtd group
   user:
     name: "{{ item }}"
     groups: "{{ ansible_role_libvirtd_user_group }}"
     append: yes
   with_items: "{{ ansible_role_libvirtd_users }}"

 - name: ensure vmlandscape mountpoint
   file:
     path: "{{ item.value.mountpoint }}"
     owner: "{{ ansible_role_libvirtd_user_group }}"
     group: "{{ ansible_role_libvirtd_user_group }}"
     state: directory
   with_dict: '{{ ansible_role_libvirtd_pools }}' 

 - name: define vmlandscape pools
   virt_pool:
     uri: '{{ ansible_role_libvirtd.qstring }}'
     name: '{{ item.key }}'
     xml: '{{ lookup("template", "dir.xml.jp2") }}'
     mode: overwrite
     state: present
     autostart: yes
   with_dict: '{{ ansible_role_libvirtd_pools }}' 
   register: vmlandscapepools

 - name: activate vmlandscape pools
   virt_pool:
     uri: '{{ ansible_role_libvirtd.qstring }}'
     name: '{{ item.key }}'
     state: active
     autostart: yes
   with_dict: '{{ ansible_role_libvirtd_pools }}' 

 - name: really autostart vmlandscape pools
   shell: 'virsh pool-autostart --pool {{ item.key }}' 
   with_dict: '{{ ansible_role_libvirtd_pools }}' 
   when: vmlandscapepools.changed

 - name: define vmlandscape nets
   virt_net:
     uri: '{{ ansible_role_libvirtd.qstring }}'
     name: '{{ item.key }}'
     xml: '{{ lookup("template", "net.xml.jp2") }}'
     command: define
   with_dict: '{{ ansible_role_libvirtd_nets }}' 
   register: vmlandscapenets

 - name: start vmlandscape nets
   virt_net:
     uri: '{{ ansible_role_libvirtd.qstring }}'
     name: '{{ item.key }}'
     autostart: yes
     state: active
   with_dict: '{{ ansible_role_libvirtd_nets }}' 

 - name: really autostart vmlandscape nets
   shell: 'virsh net-autostart --network {{ item.key }}' 
   with_dict: '{{ ansible_role_libvirtd_nets }}' 
   when: vmlandscapenets.changed

 - name: create dirs in vmlandscape control dir
   file:
     path: "{{ ansible_role_libvirtd.mntpointcontrol }}/{{ item }}"
     state: directory
     owner: root
     mode: g+rws
     group: '{{ ansible_role_libvirtd_user_group }}'
   with_items:
   - sbin
   - bin
   - isos
   - public_html

 - name: create shell
   template:
     src: "create-vm.sh.j2"
     dest: "{{ ansible_role_libvirtd.mntpointcontrol }}/bin/create-vm-{{ item.key }}.sh"
     mode: 0755
     owner: root
     group: root
   tags:
   - shell
   with_dict: "{{ ansible_role_libvirtd_virtoses }}"

 - name: install apache
   package:
     name: apache2

 - name: enable service
   service:
     name: apache2
     state: started
     enabled: true

 - name: install vmlandscape preseed host configuration
   template:
     src: vmlandscape.conf.j2
     dest: /etc/apache2/sites-available/vmlandscape.conf
   notify: apache_reload

 - name: symlink vmlandscape to sites-enabled
   file:
     src: ../sites-available/vmlandscape.conf
     dest: /etc/apache2/sites-enabled/vmlandscape.conf
     state: link
   notify: apache_reload

 - name: create deployment dirs
   file:
     dest: "{{ ansible_role_libvirtd.mntpointcontrol }}/public_html/{{ item }}"
     state: directory
   with_items:
   - opensuse
   - debian
   tags:
   - shell

 - name: deploy preseed
   template:
     src: "{{ item }}.preseed.j2"
     dest: "{{ ansible_role_libvirtd.mntpointcontrol }}/public_html/{{ item }}/{{ item }}.preseed"
   with_items:
   - opensuse
   - debian
   tags:
   - shell

 - name: deploy superuser scripts
   copy:
     src: "sbin/{{ item }}"
     dest: "{{ ansible_role_libvirtd.mntpointcontrol }}/sbin/{{ item }}"
     mode: 0755
   with_items:
   - vm-destroy.sh

 - name: deploy clone script with user contenxt
   template:
     src: debian-base-9-clone.sh.j2
     dest: "{{ ansible_role_libvirtd.mntpointcontrol }}/sbin/debian-base-9-clone.sh"
     mode: 0755
